# Distributed Systems Challenges - Part 3: Distributed Tracing

## ğŸ” Distributed Tracing: Request Correlation, Span Propagation

---

## 1. Distributed Tracing Overview

### The Problem
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Tracing Problem in Microservices                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Request:
    User
      â”‚
      â”‚ HTTP Request
      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  API     â”‚
    â”‚ Gateway  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â–º Service A
         â”‚      â”‚
         â”‚      â”œâ”€â”€â”€â–º Service B
         â”‚      â”‚      â”‚
         â”‚      â”‚      â””â”€â”€â”€â–º Database
         â”‚      â”‚
         â”‚      â””â”€â”€â”€â–º Service C
         â”‚             â”‚
         â”‚             â””â”€â”€â”€â–º External API
         â”‚
         â””â”€â”€â”€â–º Service D
                â”‚
                â””â”€â”€â”€â–º Cache

Problems:
âŒ Which service caused the error?
âŒ How long did each service take?
âŒ What was the request path?
âŒ Where is the bottleneck?
âŒ How to correlate logs across services?
```

### What is Distributed Tracing?
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Distributed Tracing Concept                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Tracing captures:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Request Journey                     â”‚
    â”‚                                      â”‚
    â”‚  Start: User Request                â”‚
    â”‚    â”‚                                 â”‚
    â”‚    â”œâ”€â–º Service A (50ms)            â”‚
    â”‚    â”‚   â”‚                            â”‚
    â”‚    â”‚   â”œâ”€â–º Service B (30ms)        â”‚
    â”‚    â”‚   â”‚   â”‚                        â”‚
    â”‚    â”‚   â”‚   â””â”€â–º DB Query (20ms)     â”‚
    â”‚    â”‚   â”‚                            â”‚
    â”‚    â”‚   â””â”€â–º Service C (40ms)        â”‚
    â”‚    â”‚                                â”‚
    â”‚    â””â”€â–º Service D (25ms)            â”‚
    â”‚                                    â”‚
    â”‚  Total: 145ms                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
Benefits:
âœ… See complete request flow
âœ… Identify bottlenecks
âœ… Debug errors across services
âœ… Performance analysis
âœ… Service dependencies
```

---

## 2. Core Concepts

### Trace, Span, and Context
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Trace Components                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Trace:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Complete request journey          â”‚
    â”‚  Contains multiple spans            â”‚
    â”‚  Has unique Trace ID                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Span:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Single operation                   â”‚
    â”‚  - Service call                     â”‚
    â”‚  - Database query                   â”‚
    â”‚  - External API call                â”‚
    â”‚  Has unique Span ID                 â”‚
    â”‚  Has parent Span ID                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Trace Context:
    - Trace ID (same for all spans)
    - Span ID (unique per span)
    - Parent Span ID
    - Baggage (custom key-value pairs)
```

### Trace Structure
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Trace Structure                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Trace (TraceID: abc123)
â”‚
â”œâ”€ Span 1: API Gateway (SpanID: s1, Parent: null)
â”‚   â”‚
â”‚   â”œâ”€ Span 2: Service A (SpanID: s2, Parent: s1)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€ Span 3: Service B (SpanID: s3, Parent: s2)
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â””â”€ Span 4: DB Query (SpanID: s4, Parent: s3)
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€ Span 5: Service C (SpanID: s5, Parent: s2)
â”‚   â”‚
â”‚   â””â”€ Span 6: Service D (SpanID: s6, Parent: s1)
â”‚
Timeline:
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ s1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚      â”‚ s2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚      â”‚     â”‚ s3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
â”‚      â”‚     â”‚     â”‚ s4 â”€â”€â”€â”€â”‚                        â”‚
â”‚      â”‚     â”‚     â”‚        â”‚                        â”‚
â”‚      â”‚     â”‚ s5 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
â”‚      â”‚     â”‚               â”‚                        â”‚
â”‚      â”‚ s6 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

---

## 3. Request Correlation

### Trace ID Propagation
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Trace ID Propagation                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Initial Request
    Client
      â”‚
      â”‚ HTTP Request
      â”‚ (no trace headers)
      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  API     â”‚  â† Generates TraceID: abc123
    â”‚ Gateway  â”‚     Generates SpanID: s1
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ HTTP Request
         â”‚ Headers:
         â”‚   X-Trace-ID: abc123
         â”‚   X-Span-ID: s1
         â”‚   X-Parent-Span-ID: null
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Service  â”‚  â† Receives TraceID: abc123
    â”‚    A     â”‚     Receives Parent SpanID: s1
    â”‚          â”‚     Generates SpanID: s2
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ HTTP Request
         â”‚ Headers:
         â”‚   X-Trace-ID: abc123
         â”‚   X-Span-ID: s2
         â”‚   X-Parent-Span-ID: s1
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Service  â”‚  â† Receives TraceID: abc123
    â”‚    B     â”‚     Receives Parent SpanID: s2
    â”‚          â”‚     Generates SpanID: s3
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### HTTP Headers for Correlation
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Standard Trace Headers                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

W3C Trace Context (Standard):
    traceparent: 00-{trace-id}-{parent-id}-{flags}
    tracestate: {key}={value}

Example:
    traceparent: 00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01
    â”‚           â”‚  â”‚                                    â”‚              â”‚
    â”‚           â”‚  â”‚                                    â”‚              â””â”€ Flags
    â”‚           â”‚  â”‚                                    â””â”€ Parent Span ID
    â”‚           â”‚  â””â”€ Trace ID (32 hex chars)
    â”‚           â””â”€ Version
    â””â”€ Format

Custom Headers (Common):
    X-Trace-ID: abc123
    X-Span-ID: s1
    X-Parent-Span-ID: null
    X-Request-ID: req-456
```

### Correlation in Action
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Request Correlation Flow                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Request Flow:
    User Request
      â”‚
      â”‚ TraceID: abc123
      â–¼
    API Gateway
      â”‚
      â”‚ TraceID: abc123, SpanID: s1
      â”œâ”€â”€â”€â–º Service A
      â”‚      â”‚
      â”‚      â”‚ TraceID: abc123, SpanID: s2, Parent: s1
      â”‚      â”œâ”€â”€â”€â–º Service B
      â”‚      â”‚      â”‚
      â”‚      â”‚      â”‚ TraceID: abc123, SpanID: s3, Parent: s2
      â”‚      â”‚      â””â”€â”€â”€â–º Database
      â”‚      â”‚             â”‚
      â”‚      â”‚             â”‚ TraceID: abc123, SpanID: s4, Parent: s3
      â”‚      â”‚
      â”‚      â””â”€â”€â”€â–º Service C
      â”‚             â”‚
      â”‚             â”‚ TraceID: abc123, SpanID: s5, Parent: s2
      â”‚
      â””â”€â”€â”€â–º Service D
             â”‚
             â”‚ TraceID: abc123, SpanID: s6, Parent: s1

All spans share same TraceID: abc123
Can reconstruct complete request path
```

---

## 4. Span Propagation

### Span Creation
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Span Creation Process                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Service A receives request:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  1. Extract trace context          â”‚
    â”‚     - TraceID from header          â”‚
    â”‚     - Parent SpanID from header    â”‚
    â”‚                                     â”‚
    â”‚  2. Create new span                â”‚
    â”‚     - Generate SpanID              â”‚
    â”‚     - Set parent = received        â”‚
    â”‚     - Set trace = received         â”‚
    â”‚                                     â”‚
    â”‚  3. Start span                     â”‚
    â”‚     - Record start time            â”‚
    â”‚     - Add tags/metadata            â”‚
    â”‚                                     â”‚
    â”‚  4. Process request                â”‚
    â”‚     - Business logic               â”‚
    â”‚     - Call other services          â”‚
    â”‚                                     â”‚
    â”‚  5. End span                       â”‚
    â”‚     - Record end time              â”‚
    â”‚     - Calculate duration           â”‚
    â”‚     - Send to trace backend        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Span Propagation Types
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Span Propagation Types                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Child Span (Synchronous):
    Parent Span
      â”‚
      â”‚â”€â”€â”€â–º Child Span
      â”‚      â”‚
      â”‚      â””â”€â”€â”€â–º Process
      â”‚
      â””â”€â”€â”€â–º Continue after child completes
      
2. Follows-From Span (Asynchronous):
    Parent Span
      â”‚
      â”‚â”€â”€â”€â–º Fire-and-forget
      â”‚      â”‚
      â”‚      â””â”€â”€â”€â–º Async Span (follows-from)
      â”‚
      â””â”€â”€â”€â–º Continue immediately
      
3. Concurrent Spans:
    Parent Span
      â”‚
      â”œâ”€â”€â”€â–º Child Span 1 (parallel)
      â”‚
      â””â”€â”€â”€â–º Child Span 2 (parallel)
```

### Span Propagation Example
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Span Propagation Example                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Service A:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Span: s1                           â”‚
    â”‚  Operation: ProcessOrder            â”‚
    â”‚  Start: 10:00:00.000                â”‚
    â”‚                                     â”‚
    â”‚  Call Service B:                    â”‚
    â”‚    - Create child span s2           â”‚
    â”‚    - Propagate: TraceID, s2, s1    â”‚
    â”‚                                     â”‚
    â”‚  Call Service C (async):            â”‚
    â”‚    - Create follows-from span s3    â”‚
    â”‚    - Propagate: TraceID, s3, s1    â”‚
    â”‚                                     â”‚
    â”‚  End: 10:00:00.150                  â”‚
    â”‚  Duration: 150ms                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚
         â”‚                    â”‚
         â–¼                    â–¼
    Service B:           Service C:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Span: s2 â”‚        â”‚ Span: s3 â”‚
    â”‚ Parent: s1â”‚        â”‚ Parent: s1â”‚
    â”‚ Start:    â”‚        â”‚ Start:    â”‚
    â”‚ 10:00:00.050â”‚        â”‚ 10:00:00.100â”‚
    â”‚ End:      â”‚        â”‚ End:      â”‚
    â”‚ 10:00:00.120â”‚        â”‚ 10:00:00.200â”‚
    â”‚ Duration: â”‚        â”‚ Duration: â”‚
    â”‚ 70ms      â”‚        â”‚ 100ms     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Span Attributes

### Span Data Structure
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Span Attributes                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Span {
    TraceID: "abc123"
    SpanID: "s1"
    ParentSpanID: null
    
    Operation: "GET /api/users"
    Service: "user-service"
    
    StartTime: 2024-01-01T10:00:00.000Z
    EndTime: 2024-01-01T10:00:00.150Z
    Duration: 150ms
    
    Status: "OK" | "ERROR"
    Error: null | ErrorMessage
    
    Tags: {
        "http.method": "GET"
        "http.url": "/api/users"
        "http.status_code": 200
        "user.id": "12345"
    }
    
    Logs: [
        {timestamp: "...", message: "Processing request"},
        {timestamp: "...", message: "Querying database"}
    ]
    
    Baggage: {
        "user-id": "12345"
        "request-source": "mobile"
    }
}
```

### Span Tags and Logs
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Span Tags and Logs                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Tags (Key-Value pairs):
    - http.method: "GET"
    - http.status_code: 200
    - db.query: "SELECT * FROM users"
    - cache.hit: true
    - user.id: "12345"
    - error: false
    
Logs (Events with timestamps):
    [
        {time: "10:00:00.010", level: "INFO", msg: "Request received"},
        {time: "10:00:00.050", level: "DEBUG", msg: "Querying database"},
        {time: "10:00:00.120", level: "INFO", msg: "Response sent"}
    ]
    
Baggage (Propagated context):
    - Custom key-value pairs
    - Passed to child spans
    - Used for cross-cutting concerns
```

---

## 6. Trace Collection and Storage

### Trace Collection Architecture
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Trace Collection                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Services:
    â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”
    â”‚  S1  â”‚    â”‚  S2  â”‚    â”‚  S3  â”‚
    â””â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”¬â”€â”€â”€â”˜
       â”‚           â”‚           â”‚
       â”‚           â”‚           â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Trace Agent    â”‚  â† Collects spans
         â”‚  (Sidecar)      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Trace Backend  â”‚  â† Stores traces
         â”‚  (Jaeger/Zipkin)â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Trace UI       â”‚  â† Visualizes traces
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Sampling Strategies
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Trace Sampling                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Problem: Too many traces â†’ Storage/Performance issues

Solutions:

1. Head-based Sampling:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Decision at trace start            â”‚
    â”‚  Sample 10% of traces              â”‚
    â”‚  All spans in trace sampled         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. Tail-based Sampling:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Decision after trace completes     â”‚
    â”‚  Sample traces with errors          â”‚
    â”‚  Sample slow traces                 â”‚
    â”‚  Sample random traces                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. Probabilistic Sampling:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Each span sampled independently    â”‚
    â”‚  Probability: 0.1 (10%)             â”‚
    â”‚  May have incomplete traces          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Practical Examples

### Example 1: Jaeger Tracing
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Jaeger Implementation                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Service Code (Java):
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable String id) {
        Span span = tracer.nextSpan()
            .name("get-user")
            .tag("user.id", id)
            .start();
            
        try (Tracer.SpanInScope ws = tracer.withSpanInScope(span)) {
            // Business logic
            User user = userService.findById(id);
            span.tag("db.query", "SELECT * FROM users WHERE id = ?");
            return user;
        } catch (Exception e) {
            span.tag("error", true);
            span.tag("error.message", e.getMessage());
            throw e;
        } finally {
            span.end();
        }
    }

Jaeger UI:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Trace: abc123                      â”‚
    â”‚  Duration: 150ms                    â”‚
    â”‚                                     â”‚
    â”‚  [API Gateway] 50ms                â”‚
    â”‚    [Service A] 70ms                â”‚
    â”‚      [Service B] 30ms              â”‚
    â”‚        [DB Query] 20ms             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Example 2: OpenTelemetry
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              OpenTelemetry                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

OpenTelemetry SDK:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Tracer tracer =                    â”‚
    â”‚      OpenTelemetry.getGlobalTracer( â”‚
    â”‚          "my-service");             â”‚
    â”‚                                     â”‚
    â”‚  Span span = tracer                 â”‚
    â”‚      .spanBuilder("operation")      â”‚
    â”‚      .setParent(Context.current())  â”‚
    â”‚      .startSpan();                  â”‚
    â”‚                                     â”‚
    â”‚  try (Scope scope =                 â”‚
    â”‚          span.makeCurrent()) {      â”‚
    â”‚      // Business logic              â”‚
    â”‚  } finally {                        â”‚
    â”‚      span.end();                    â”‚
    â”‚  }                                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Exporters:
    - Jaeger Exporter
    - Zipkin Exporter
    - OTLP Exporter
    - Prometheus Exporter
```

### Example 3: Trace Visualization
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Trace Timeline View                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Timeline:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  0ms    50ms   100ms   150ms   200ms   250ms        â”‚
    â”‚  â”‚      â”‚      â”‚      â”‚      â”‚      â”‚              â”‚
    â”‚  â”‚ API Gateway                                      â”‚
    â”‚  â”‚      â”‚                                            â”‚
    â”‚  â”‚      â”‚ Service A                                  â”‚
    â”‚  â”‚      â”‚      â”‚                                      â”‚
    â”‚  â”‚      â”‚      â”‚ Service B                           â”‚
    â”‚  â”‚      â”‚      â”‚      â”‚                              â”‚
    â”‚  â”‚      â”‚      â”‚      â”‚ DB Query                    â”‚
    â”‚  â”‚      â”‚      â”‚      â”‚                              â”‚
    â”‚  â”‚      â”‚      â”‚ Service C                          â”‚
    â”‚  â”‚      â”‚      â”‚      â”‚                             â”‚
    â”‚  â”‚      â”‚ Service D                                 â”‚
    â”‚  â”‚      â”‚      â”‚                                     â”‚
    â””â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Service Map:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   API    â”‚
    â”‚ Gateway  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚          â”‚
    â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚  A   â”‚  â”‚  D   â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”œâ”€â”€â”€â–º B â”€â”€â”€â–º DB
   â”‚
   â””â”€â”€â”€â–º C
```

---

## 8. Best Practices

### Tracing Best Practices
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Best Practices                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Always propagate trace context
âœ… Use consistent trace IDs across services
âœ… Add meaningful span names
âœ… Include relevant tags
âœ… Sample traces (don't trace 100%)
âœ… Use async spans for async operations
âœ… Include error information
âœ… Set appropriate trace levels
âœ… Monitor trace volume
âœ… Use distributed tracing in staging first
```

### Common Mistakes
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Common Mistakes                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âŒ Not propagating trace context
âŒ Creating too many spans (overhead)
âŒ Not sampling (storage issues)
âŒ Missing error information
âŒ Inconsistent span naming
âŒ Not using baggage for context
âŒ Blocking on trace collection
âŒ Not filtering sensitive data
```

---

## Key Takeaways

### Summary
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Key Concepts                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Trace:
   - Complete request journey
   - Contains multiple spans
   - Unique Trace ID

2. Span:
   - Single operation
   - Has parent-child relationships
   - Contains timing and metadata

3. Request Correlation:
   - Propagate Trace ID via headers
   - All spans share same Trace ID
   - Reconstruct request path

4. Span Propagation:
   - Child spans (synchronous)
   - Follows-from spans (async)
   - Maintain parent relationships
```

---

**Next: Part 4 will cover Service Mesh (Istio, Linkerd, Envoy, mTLS, Traffic Management)**

