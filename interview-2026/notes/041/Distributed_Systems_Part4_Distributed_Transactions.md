# Distributed Systems - In-Depth Diagrams (Part 4: Distributed Transactions)

## ğŸ”„ Distributed Transactions: Two-Phase Commit, Saga Pattern, Compensating Transactions

---

## 1. Distributed Transactions Overview

### The Challenge
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Distributed Transaction Problem                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Single Database (ACID):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database â”‚
â”‚          â”‚
â”‚  Txn:    â”‚
â”‚  - A     â”‚  â† All or nothing
â”‚  - B     â”‚  â† Atomic
â”‚  - C     â”‚
â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Distributed (Multiple Databases):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database â”‚    â”‚ Database â”‚    â”‚ Database â”‚
â”‚    1     â”‚    â”‚    2     â”‚    â”‚    3     â”‚
â”‚          â”‚    â”‚          â”‚    â”‚          â”‚
â”‚  Txn A   â”‚    â”‚  Txn B   â”‚    â”‚  Txn C   â”‚
â”‚          â”‚    â”‚          â”‚    â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚              â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
    How to ensure all-or-nothing?
    How to coordinate across nodes?
```

---

## 2. Two-Phase Commit (2PC)

### 2PC Overview
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Two-Phase Commit Architecture                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Coordinator
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Participantâ”‚Participantâ”‚Participantâ”‚
â”‚    1     â”‚ â”‚    2     â”‚ â”‚    3     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Phases:
1. Prepare Phase (Voting)
2. Commit Phase (Decision)
```

### Phase 1: Prepare (Voting)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Phase 1: Prepare Phase                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Coordinator sends PREPARE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Coordinatorâ”‚: Send PREPARE to all participants
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â–º PREPARE â”€â”€â”€â”€â–º Participant 1
     â”‚
     â”œâ”€â”€â”€â–º PREPARE â”€â”€â”€â”€â–º Participant 2
     â”‚
     â””â”€â”€â”€â–º PREPARE â”€â”€â”€â”€â–º Participant 3

Step 2: Participants vote
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Participantâ”‚: Execute transaction locally
â”‚    1     â”‚: Write to log (prepare)
â”‚          â”‚: Lock resources
â”‚          â”‚: Send VOTE-COMMIT or VOTE-ABORT
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Coordinatorâ”‚: Collect votes
â”‚          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Votesâ”‚ â”‚  â† All VOTE-COMMIT?
â”‚  â””â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 2: Commit (Decision)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Phase 2: Commit Phase                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Case 1: All VOTE-COMMIT
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Coordinatorâ”‚: All participants voted COMMIT
â”‚          â”‚: Send COMMIT to all
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â–º COMMIT â”€â”€â”€â”€â–º Participant 1
     â”‚
     â”œâ”€â”€â”€â–º COMMIT â”€â”€â”€â”€â–º Participant 2
     â”‚
     â””â”€â”€â”€â–º COMMIT â”€â”€â”€â”€â–º Participant 3
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Participantâ”‚: Commit transaction
â”‚          â”‚: Release locks
â”‚          â”‚: Send ACK
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Case 2: Any VOTE-ABORT
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Coordinatorâ”‚: At least one ABORT
â”‚          â”‚: Send ABORT to all
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â–º ABORT â”€â”€â”€â”€â–º Participant 1
     â”‚
     â”œâ”€â”€â”€â–º ABORT â”€â”€â”€â”€â–º Participant 2
     â”‚
     â””â”€â”€â”€â–º ABORT â”€â”€â”€â”€â–º Participant 3
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Participantâ”‚: Rollback transaction
â”‚          â”‚: Release locks
â”‚          â”‚: Send ACK
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2PC State Diagram
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              2PC State Transitions                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Coordinator:
    INIT
     â”‚
     â”‚ PREPARE
     â–¼
    WAIT
     â”‚
     â”œâ”€â”€â”€â–º All COMMIT â”€â”€â”€â”€â–º COMMIT â”€â”€â”€â”€â–º END
     â”‚
     â””â”€â”€â”€â–º Any ABORT â”€â”€â”€â”€â–º ABORT â”€â”€â”€â”€â–º END

Participant:
    INIT
     â”‚
     â”‚ PREPARE
     â–¼
    PREPARED
     â”‚
     â”œâ”€â”€â”€â–º COMMIT â”€â”€â”€â”€â–º COMMITTED â”€â”€â”€â”€â–º END
     â”‚
     â””â”€â”€â”€â–º ABORT â”€â”€â”€â”€â–º ABORTED â”€â”€â”€â”€â–º END
```

### 2PC Problems
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              2PC Limitations                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Problem 1: Coordinator Failure
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Coordinatorâ”‚: Crashes after sending PREPARE
â”‚          â”‚: Participants in PREPARED state
â”‚          â”‚: Blocked waiting for decision
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
    BLOCKING (cannot proceed)

Problem 2: Network Partition
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Coordinatorâ”‚: Partitioned from participants
â”‚          â”‚: Cannot send COMMIT/ABORT
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
    BLOCKING

Problem 3: Performance
- Multiple round trips
- Synchronous blocking
- High latency
- Low throughput
```

---

## 3. Three-Phase Commit (3PC)

### 3PC Overview
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Three-Phase Commit                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Phases:
1. CanCommit (Voting)
2. PreCommit (Preparation)
3. DoCommit (Commit)

Benefits:
- Non-blocking (can recover from coordinator failure)
- Timeout-based recovery
- More resilient than 2PC
```

### 3PC Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              3PC Phase Flow                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Phase 1: CanCommit
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Coordinatorâ”‚: Send CanCommit?
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â–º CanCommit? â”€â”€â”€â”€â–º Participant
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Participantâ”‚: Check if can commit
â”‚          â”‚: Send YES or NO
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Phase 2: PreCommit
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Coordinatorâ”‚: All YES â†’ Send PreCommit
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â–º PreCommit â”€â”€â”€â”€â–º Participant
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Participantâ”‚: Prepare to commit
â”‚          â”‚: Send ACK
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Phase 3: DoCommit
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Coordinatorâ”‚: Send DoCommit
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â–º DoCommit â”€â”€â”€â”€â–º Participant
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Participantâ”‚: Commit
â”‚          â”‚: Send ACK
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Saga Pattern

### Saga Overview
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Saga Pattern                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Problem with 2PC:
- Long-lived transactions
- Distributed locks
- Poor performance

Saga Solution:
- Long-running transaction
- Broken into local transactions
- Compensating actions for rollback
- No distributed locks
```

### Saga Structure
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Saga Transaction Flow                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Saga:
    T1 â”€â”€â”€â”€â–º T2 â”€â”€â”€â”€â–º T3 â”€â”€â”€â”€â–º T4
     â”‚       â”‚       â”‚       â”‚
     â”‚       â”‚       â”‚       â”‚
     C1      C2      C3      C4 (Compensating)

T1: Book Hotel
    â”‚
    â”‚ Success
    â–¼
T2: Book Flight
    â”‚
    â”‚ Success
    â–¼
T3: Charge Credit Card
    â”‚
    â”‚ Success
    â–¼
T4: Send Confirmation
    â”‚
    â”‚ Success
    â–¼
    COMPLETE

If T3 fails:
    T1 â”€â”€â”€â”€â–º T2 â”€â”€â”€â”€â–º T3 (FAIL)
     â”‚       â”‚       â”‚
     â”‚       â”‚       â”‚
     C1      C2      â”‚
     â”‚       â”‚       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
         Rollback
```

### Saga Types

#### Choreography-Based Saga
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Choreography Saga                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Service A          Service B          Service C
    â”Œâ”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”
    â”‚      â”‚           â”‚      â”‚           â”‚      â”‚
    â”‚  T1  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  T2  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  T3  â”‚
    â”‚      â”‚           â”‚      â”‚           â”‚      â”‚
    â”‚      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚      â”‚
    â”‚  C1  â”‚           â”‚  C2  â”‚           â”‚  C3  â”‚
    â””â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”˜

Each service:
- Knows what to do next
- Publishes events
- Listens for events
- No central coordinator

Pros:
- Decoupled
- No single point of failure
- Scalable

Cons:
- Hard to understand flow
- Difficult to debug
- Eventual consistency
```

#### Orchestration-Based Saga
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Orchestration Saga                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Orchestrator
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”  â”‚
    â”‚  â”‚Sagaâ”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”˜  â”‚
    â”‚          â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Service Aâ”‚ â”‚Service Bâ”‚ â”‚Service Câ”‚
â”‚         â”‚ â”‚         â”‚ â”‚         â”‚
â”‚   T1    â”‚ â”‚   T2    â”‚ â”‚   T3    â”‚
â”‚         â”‚ â”‚         â”‚ â”‚         â”‚
â”‚   C1    â”‚ â”‚   C2    â”‚ â”‚   C3    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Orchestrator:
- Controls flow
- Calls services in order
- Handles compensation
- Centralized logic

Pros:
- Easy to understand
- Centralized control
- Easier to debug

Cons:
- Single point of failure
- Tight coupling
```

---

## 5. Compensating Transactions

### Compensating Transaction Concept
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Compensating Transactions                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Forward Transaction:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service  â”‚: Book Hotel
â”‚          â”‚: Reserve Room 101
â”‚          â”‚: Charge $100
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Compensating Transaction:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service  â”‚: Cancel Hotel Booking
â”‚          â”‚: Release Room 101
â”‚          â”‚: Refund $100
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Properties:
- Idempotent (can run multiple times)
- Commutative (order doesn't matter)
- May not fully reverse (side effects)
```

### Compensating Transaction Example
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              E-Commerce Saga                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Order Saga:
    T1: Reserve Inventory
         â”‚
         â”‚ Compensating: Release Inventory
         â”‚
    T2: Charge Credit Card
         â”‚
         â”‚ Compensating: Refund Payment
         â”‚
    T3: Ship Order
         â”‚
         â”‚ Compensating: Cancel Shipment
         â”‚
    T4: Send Email
         â”‚
         â”‚ Compensating: Send Cancellation Email

If T2 fails:
    T1: Reserve Inventory âœ“
    T2: Charge Credit Card âœ— (FAILED)
         â”‚
         â–¼
    C1: Release Inventory (compensate T1)
         â”‚
         â–¼
    Rollback Complete
```

### Compensating Transaction Challenges
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Compensation Challenges                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Challenge 1: Side Effects
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service  â”‚: Send Email (T4)
â”‚          â”‚: Email sent (cannot unsend)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
    C4: Send Cancellation Email
    (Mitigation, not true reversal)

Challenge 2: Partial Compensation
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service  â”‚: Ship Order (T3)
â”‚          â”‚: Package shipped
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
    C3: Cancel Shipment
    (May incur costs, cannot fully reverse)

Challenge 3: Compensation Failure
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service  â”‚: C1 fails (cannot release inventory)
â”‚          â”‚: Manual intervention needed
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Distributed Transaction Patterns

### TCC Pattern (Try-Confirm-Cancel)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              TCC Pattern                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Phase 1: Try
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service  â”‚: Try Reserve Inventory
â”‚          â”‚: Lock resources
â”‚          â”‚: Prepare state
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Phase 2: Confirm (if all Try succeed)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service  â”‚: Confirm Reservation
â”‚          â”‚: Commit changes
â”‚          â”‚: Release locks
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Phase 3: Cancel (if any Try fails)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service  â”‚: Cancel Reservation
â”‚          â”‚: Rollback changes
â”‚          â”‚: Release locks
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Benefits:
- Explicit resource management
- No long locks
- Better performance than 2PC
```

### Outbox Pattern
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Outbox Pattern                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Local Transaction:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database  â”‚
â”‚           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚Data â”‚  â”‚  â† Update data
â”‚  â””â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚Outboxâ”‚  â”‚  â† Write event to outbox
â”‚  â””â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ (Same transaction)
     â”‚
     â–¼
    COMMIT (atomic)

Outbox Processor:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Processor â”‚: Read from outbox
â”‚           â”‚: Publish event
â”‚           â”‚: Mark as sent
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Benefits:
- Atomic local transaction
- Reliable event publishing
- No dual-write problem
```

---

## 7. Comparison: 2PC vs Saga

### Feature Comparison
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              2PC vs Saga                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Feature         2PC              Saga
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Lock Duration   Short            Long (local only)
Performance     Lower            Higher
Latency         Higher           Lower
Throughput      Lower            Higher
Failure Mode    Blocking         Compensating
Complexity      Medium            Higher
Use Case        Short txns       Long txns
Consistency     Strong           Eventual
```

### When to Use
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              When to Use Which                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Use 2PC when:
- Short transactions
- Strong consistency required
- All participants available
- Low latency acceptable

Use Saga when:
- Long-running transactions
- High performance needed
- Eventual consistency OK
- Microservices architecture
```

---

## Key Takeaways

### Distributed Transaction Summary
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Key Concepts                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2PC:
- Synchronous
- Strong consistency
- Blocking on failure
- Good for short transactions

Saga:
- Asynchronous
- Eventual consistency
- Compensating actions
- Good for long transactions

Compensating Transactions:
- Reverse forward actions
- May not fully reverse
- Must be idempotent
- Handle side effects
```

---

**Next: Part 5 will cover Consensus Algorithms (Raft, Paxos, Byzantine).**

