# Distributed Patterns - Complete Diagrams Guide (Part 7: Outbox Pattern)

## ğŸ“¦ Outbox Pattern

---

## 1. Outbox Pattern Overview

### Problem: Reliable Event Publishing
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              The Problem                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Service A
    â”‚
    â”‚ 1. Update Database
    â”‚    â”€â”€â–º âœ… Success
    â”‚
    â”‚ 2. Publish Event
    â”‚    â”€â”€â–º âŒ Failure (message broker down)
    â”‚
    â–¼
Problem:
- Database updated but event not published
- Inconsistent state
- Lost events
- Cannot use distributed transactions

Solution: Outbox Pattern
- Write event to database first
- Separate process publishes events
- Guarantees at-least-once delivery
```

### Outbox Pattern Concept
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Outbox Pattern                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Service
    â”‚
    â”‚ 1. Begin Transaction
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Business Logic  â”‚
â”‚  Update Domain   â”‚
â”‚  Data            â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 2. Write to Outbox Table
     â”‚    (same transaction)
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Outbox Table    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ eventId     â”‚ â”‚
â”‚  â”‚ eventType   â”‚ â”‚
â”‚  â”‚ payload     â”‚ â”‚
â”‚  â”‚ status      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 3. Commit Transaction
     â”‚    â”€â”€â–º âœ… Both saved atomically
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Outbox          â”‚
â”‚  Publisher       â”‚  â† Separate process
â”‚  (Polling)       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 4. Read unpublished events
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Message Broker  â”‚
â”‚  (Kafka/RabbitMQ)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Outbox Table Schema

### Database Schema
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Outbox Table Schema                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

outbox_events Table:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Column          | Type              â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚  id              | UUID (PK)         â”‚
    â”‚  aggregate_id    | VARCHAR           â”‚
    â”‚  event_type      | VARCHAR           â”‚
    â”‚  payload         | JSON/TEXT         â”‚
    â”‚  status          | VARCHAR            â”‚
    â”‚  created_at      | TIMESTAMP         â”‚
    â”‚  published_at    | TIMESTAMP (NULL)  â”‚
    â”‚  retry_count     | INTEGER           â”‚
    â”‚  error_message   | TEXT (NULL)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Status Values:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  PENDING    - Not yet published    â”‚
    â”‚  PUBLISHING - Currently publishing  â”‚
    â”‚  PUBLISHED  - Successfully sent     â”‚
    â”‚  FAILED     - Publishing failed     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Example Record:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  id: "evt-123"                      â”‚
    â”‚  aggregate_id: "order-456"         â”‚
    â”‚  event_type: "OrderCreated"        â”‚
    â”‚  payload: {"orderId": "order-456",  â”‚
    â”‚            "amount": 100.00}        â”‚
    â”‚  status: "PENDING"                  â”‚
    â”‚  created_at: "2024-01-15 10:00:00" â”‚
    â”‚  published_at: NULL                â”‚
    â”‚  retry_count: 0                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Outbox Flow Diagram

### Complete Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Outbox Pattern Flow                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Business Transaction
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Order   â”‚
    â”‚ Service  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Begin Transaction
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Update  â”‚
    â”‚  Order   â”‚
    â”‚  Table   â”‚
    â”‚  â”€â”€â–º âœ…  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Same Transaction
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Insert  â”‚
    â”‚  into    â”‚
    â”‚  Outbox  â”‚
    â”‚  â”€â”€â–º âœ…  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Commit Transaction
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Both    â”‚
    â”‚  Saved   â”‚
    â”‚  âœ…      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: Event Publishing (Separate Process)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Outbox   â”‚
    â”‚ Publisherâ”‚
    â”‚ (Polling)â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Poll for PENDING events
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  SELECT  â”‚
    â”‚  FROM    â”‚
    â”‚  outbox  â”‚
    â”‚  WHERE   â”‚
    â”‚  status  â”‚
    â”‚  =       â”‚
    â”‚  PENDING â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Update status to PUBLISHING
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Publish â”‚
    â”‚  to      â”‚
    â”‚  Message â”‚
    â”‚  Broker  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
    â–¼         â–¼
Success    Failure
    â”‚         â”‚
    â”‚         â–¼
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    â”‚ Retry    â”‚
    â”‚    â”‚ Logic    â”‚
    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Update  â”‚
â”‚  status  â”‚
â”‚  to      â”‚
â”‚  PUBLISHEDâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Transactional Outbox

### Atomic Write
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Transactional Outbox                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Database Transaction:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  BEGIN TRANSACTION                   â”‚
    â”‚                                      â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ UPDATE orders                  â”‚  â”‚
    â”‚  â”‚ SET status = 'CREATED'         â”‚  â”‚
    â”‚  â”‚ WHERE id = 'order-123'         â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                      â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ INSERT INTO outbox_events      â”‚  â”‚
    â”‚  â”‚ (id, event_type, payload)      â”‚  â”‚
    â”‚  â”‚ VALUES                         â”‚  â”‚
    â”‚  â”‚ ('evt-456', 'OrderCreated',    â”‚  â”‚
    â”‚  â”‚  '{"orderId": "order-123"}')  â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                      â”‚
    â”‚  COMMIT TRANSACTION                  â”‚
    â”‚  â”€â”€â–º Both operations atomic          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Benefits:
- Atomic operation
- No lost events
- Consistent state
- ACID guarantees
```

---

## 5. Outbox Publisher

### Publisher Implementation
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Outbox Publisher                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Publisher Process:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  @Scheduled(fixedDelay = 1000)      â”‚
    â”‚  public void publishEvents() {       â”‚
    â”‚    // 1. Fetch pending events        â”‚
    â”‚    List<OutboxEvent> events =       â”‚
    â”‚      outboxRepository                â”‚
    â”‚        .findByStatus("PENDING")      â”‚
    â”‚        .limit(100);                  â”‚
    â”‚                                      â”‚
    â”‚    for (OutboxEvent event : events) {â”‚
    â”‚      try {                           â”‚
    â”‚        // 2. Mark as publishing     â”‚
    â”‚        event.setStatus("PUBLISHING");â”‚
    â”‚        outboxRepository.save(event);  â”‚
    â”‚                                      â”‚
    â”‚        // 3. Publish to broker       â”‚
    â”‚        messageBroker.publish(        â”‚
    â”‚          event.getEventType(),       â”‚
    â”‚          event.getPayload()          â”‚
    â”‚        );                            â”‚
    â”‚                                      â”‚
    â”‚        // 4. Mark as published      â”‚
    â”‚        event.setStatus("PUBLISHED"); â”‚
    â”‚        event.setPublishedAt(now()); â”‚
    â”‚        outboxRepository.save(event); â”‚
    â”‚                                      â”‚
    â”‚      } catch (Exception e) {        â”‚
    â”‚        // 5. Handle failure          â”‚
    â”‚        event.setStatus("FAILED");    â”‚
    â”‚        event.setErrorMessage(        â”‚
    â”‚          e.getMessage()              â”‚
    â”‚        );                            â”‚
    â”‚        event.incrementRetryCount();  â”‚
    â”‚        outboxRepository.save(event);  â”‚
    â”‚      }                               â”‚
    â”‚    }                                 â”‚
    â”‚  }                                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Idempotency in Outbox

### Handling Duplicate Publishing
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Idempotency Handling                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Publisher Process:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  1. Fetch PENDING events             â”‚
    â”‚     â”‚                                â”‚
    â”‚     â–¼                                â”‚
    â”‚  2. Update status to PUBLISHING     â”‚
    â”‚     (prevents concurrent processing)â”‚
    â”‚     â”‚                                â”‚
    â”‚     â–¼                                â”‚
    â”‚  3. Publish to message broker        â”‚
    â”‚     â”‚                                â”‚
    â”‚     â”œâ”€â”€â”€â–º Success                   â”‚
    â”‚     â”‚     â”‚                          â”‚
    â”‚     â”‚     â–¼                          â”‚
    â”‚     â”‚  4. Update status to PUBLISHEDâ”‚
    â”‚     â”‚                                â”‚
    â”‚     â””â”€â”€â”€â–º Failure                    â”‚
    â”‚           â”‚                          â”‚
    â”‚           â–¼                          â”‚
    â”‚       5. Retry Logic                 â”‚
    â”‚          â”‚                          â”‚
    â”‚          â”œâ”€â”€â”€â–º Retry count < max     â”‚
    â”‚          â”‚     â”‚                    â”‚
    â”‚          â”‚     â–¼                    â”‚
    â”‚          â”‚    Set status to PENDING â”‚
    â”‚          â”‚    (for next poll)       â”‚
    â”‚          â”‚                          â”‚
    â”‚          â””â”€â”€â”€â–º Retry count >= max  â”‚
    â”‚                â”‚                    â”‚
    â”‚                â–¼                    â”‚
    â”‚            Set status to FAILED     â”‚
    â”‚            (manual intervention)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Idempotency Key:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Include eventId in message         â”‚
    â”‚  Consumers check eventId            â”‚
    â”‚  Skip if already processed          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Outbox Cleanup

### Event Cleanup Strategy
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Outbox Cleanup                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Cleanup Process:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  @Scheduled(cron = "0 0 2 * * *")   â”‚
    â”‚  public void cleanupOldEvents() {   â”‚
    â”‚    // Delete published events       â”‚
    â”‚    // older than 7 days             â”‚
    â”‚    LocalDateTime cutoff =            â”‚
    â”‚      LocalDateTime.now()             â”‚
    â”‚        .minusDays(7);                â”‚
    â”‚                                      â”‚
    â”‚    outboxRepository                  â”‚
    â”‚      .deleteByStatusAndPublishedAtBefore(â”‚
    â”‚        "PUBLISHED",                  â”‚
    â”‚        cutoff                        â”‚
    â”‚      );                              â”‚
    â”‚                                      â”‚
    â”‚    // Archive failed events          â”‚
    â”‚    // for manual review              â”‚
    â”‚    outboxRepository                  â”‚
    â”‚      .findByStatusAndCreatedAtBefore(â”‚
    â”‚        "FAILED",                     â”‚
    â”‚        cutoff                        â”‚
    â”‚      )                               â”‚
    â”‚      .forEach(event ->               â”‚
    â”‚        archiveService.archive(event) â”‚
    â”‚      );                              â”‚
    â”‚  }                                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Retention Policy:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  PUBLISHED events:                  â”‚
    â”‚  - Keep for 7 days                  â”‚
    â”‚  - Then delete                      â”‚
    â”‚                                      â”‚
    â”‚  FAILED events:                     â”‚
    â”‚  - Keep for 30 days                 â”‚
    â”‚  - Archive for review               â”‚
    â”‚                                      â”‚
    â”‚  PENDING events:                    â”‚
    â”‚  - Keep until published             â”‚
    â”‚  - Alert if > 1 hour old            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Real-World Example

### Order Service with Outbox
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Order Service Example                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Order Creation Flow:
    1. Customer places order
       â”‚
       â–¼
    Order Service
       â”‚
       â”‚ Begin Transaction
       â”‚
       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  INSERT  â”‚
    â”‚  INTO    â”‚
    â”‚  orders  â”‚
    â”‚  â”€â”€â–º âœ…  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Same Transaction
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  INSERT  â”‚
    â”‚  INTO    â”‚
    â”‚  outbox  â”‚
    â”‚  â”€â”€â–º âœ…  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Commit
         â”‚
         â–¼
    Transaction Complete âœ…

Outbox Publisher (Separate Process):
    Polls every 1 second
       â”‚
       â–¼
    Finds PENDING event
       â”‚
       â–¼
    Publishes to Kafka:
    Topic: order-events
    Message: {
      "eventId": "evt-123",
      "eventType": "OrderCreated",
      "orderId": "order-456",
      "amount": 100.00
    }
       â”‚
       â–¼
    Updates status to PUBLISHED âœ…

Downstream Services:
    - Payment Service (subscribes)
    - Inventory Service (subscribes)
    - Notification Service (subscribes)
```

---

## Key Concepts Summary

### Outbox Pattern Benefits
```
âœ… Reliable event publishing
âœ… Atomic operations
âœ… No lost events
âœ… Consistent state
âœ… Works with any database
âœ… No distributed transactions needed
```

### Outbox Pattern Challenges
```
âŒ Additional table needed
âŒ Separate publisher process
âŒ Eventual consistency (not immediate)
âŒ Cleanup required
âŒ Monitoring needed
```

### Best Practices
```
1. Use same transaction for outbox write
2. Implement idempotency in consumers
3. Monitor publisher health
4. Implement retry logic
5. Clean up old events
6. Alert on stuck events
7. Use batch processing for efficiency
```

---

**Next: Part 8 will cover Idempotency Keys.**

